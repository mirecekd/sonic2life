<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic2Life Admin</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --surface: #16213e;
            --card: #0f3460;
            --accent: #e94560;
            --accent2: #533483;
            --text: #eee;
            --text-dim: #aab;
            --success: #4caf50;
            --warn: #ff9800;
            --border: #2a3a5e;
            --input-bg: #1a2744;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        header {
            background: var(--surface);
            border-bottom: 2px solid var(--accent);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 { font-size: 1.4rem; }
        header h1 span { color: var(--accent); }
        header a { color: var(--text-dim); text-decoration: none; font-size: .9rem; }
        header a:hover { color: var(--text); }
        nav {
            background: var(--surface);
            display: flex;
            gap: 0;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
        }
        nav button {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: .8rem 1.4rem;
            cursor: pointer;
            font-size: .9rem;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all .2s;
        }
        nav button:hover { color: var(--text); background: rgba(255,255,255,.03); }
        nav button.active { color: var(--accent); border-bottom-color: var(--accent); }
        main { padding: 1.5rem; max-width: 1100px; margin: 0 auto; }
        .section { display: none; }
        .section.active { display: block; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }
        .card h3 { font-size: 1rem; margin-bottom: .8rem; color: var(--accent); }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.2rem;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-card .num { font-size: 2rem; font-weight: 700; color: var(--accent); }
        .stat-card .label { font-size: .8rem; color: var(--text-dim); margin-top: .3rem; }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: .85rem;
        }
        th, td {
            padding: .6rem .8rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th { color: var(--text-dim); font-weight: 600; font-size: .75rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,.03); }
        .badge {
            display: inline-block;
            padding: .15rem .5rem;
            border-radius: 8px;
            font-size: .75rem;
            font-weight: 600;
        }
        .badge-on { background: var(--success); color: #fff; }
        .badge-off { background: #666; color: #ccc; }
        input, select, textarea {
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: .5rem .7rem;
            border-radius: 6px;
            font-size: .85rem;
            width: 100%;
        }
        textarea { min-height: 80px; resize: vertical; font-family: inherit; }
        select { cursor: pointer; }
        label { display: block; font-size: .8rem; color: var(--text-dim); margin-bottom: .3rem; margin-top: .6rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .8rem; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: .8rem; }
        button, .btn {
            cursor: pointer;
            font-size: .85rem;
            border: none;
            border-radius: 6px;
            padding: .5rem 1rem;
            transition: all .2s;
        }
        .btn-primary { background: var(--accent); color: #fff; }
        .btn-primary:hover { background: #d63050; }
        .btn-sm { padding: .3rem .6rem; font-size: .75rem; }
        .btn-danger { background: #c0392b; color: #fff; }
        .btn-danger:hover { background: #a93226; }
        .btn-success { background: var(--success); color: #fff; }
        .btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }
        .btn-ghost:hover { color: var(--text); border-color: var(--text-dim); }
        .actions { display: flex; gap: .4rem; }
        .mt-1 { margin-top: .8rem; }
        .toast {
            position: fixed; bottom: 1.5rem; right: 1.5rem;
            background: var(--success); color: #fff;
            padding: .7rem 1.2rem; border-radius: 8px;
            font-size: .85rem; z-index: 999;
            animation: slideIn .3s ease;
        }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .empty { text-align: center; color: var(--text-dim); padding: 2rem; font-size: .9rem; }
        .upcoming-list { list-style: none; }
        .upcoming-list li { padding: .4rem 0; border-bottom: 1px solid var(--border); font-size: .85rem; }
        .upcoming-list li:last-child { border-bottom: none; }
        @media (max-width: 600px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            main { padding: 1rem; }
            header { padding: .8rem 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1><span>Sonic2Life</span> Admin</h1>
        <a href="/">&#8592; Back to App</a>
    </header>

    <nav id="nav">
        <button data-tab="dashboard" class="active">&#128202; Dashboard</button>
        <button data-tab="settings">&#9881; Settings</button>
        <button data-tab="medications">&#128138; Medications</button>
        <button data-tab="events">&#128197; Events</button>
        <button data-tab="memory">&#129504; Memory</button>
        <button data-tab="files">&#128193; Files</button>
        <button data-tab="contacts">&#128222; Contacts</button>
        <a href="/logout" style="margin-left:auto;color:#ff6b6b;text-decoration:none;font-size:0.9rem;padding:8px 16px;border:1px solid #ff6b6b;border-radius:8px;transition:all 0.3s" onmouseover="this.style.background='#ff6b6b';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#ff6b6b'">&#128682; Logout</a>
    </nav>

    <main>
        <!-- â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-dashboard" class="section active">
            <div class="stats-grid" id="dashboard-stats"></div>
            <div class="card mt-1">
                <h3>&#128197; Upcoming Events</h3>
                <ul class="upcoming-list" id="dashboard-upcoming"></ul>
            </div>
            <div class="card mt-1">
                <h3>&#128244; Push Subscriptions</h3>
                <div style="margin-bottom:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                    <button class="btn btn-sm" onclick="loadPushSubscriptions()" title="Refresh">ğŸ”„ Refresh</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteAllPushSubs()" title="Delete all subscriptions">ğŸ—‘ï¸ Delete All</button>
                    <button class="btn btn-sm btn-warning" onclick="deleteStalePushSubs()" title="Delete subscriptions with failures">âš ï¸ Delete Stale</button>
                </div>
                <div style="overflow-x:auto">
                    <table class="data-table" id="push-subs-table">
                        <thead>
                            <tr>
                                <th>Endpoint</th>
                                <th>User Agent</th>
                                <th>Created</th>
                                <th>Last Success</th>
                                <th>Fails</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="push-subs-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-settings" class="section">
            <div class="card">
                <h3>&#9881; Application Settings</h3>
                <div id="settings-form"></div>
                <div class="mt-1">
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>

        <!-- â”€â”€ Medications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-medications" class="section">
            <div class="card">
                <h3>&#128138; Add Medication</h3>
                <div class="form-row">
                    <div><label>Name</label><input id="med-name" placeholder="e.g. Aspirin"></div>
                    <div><label>Dosage</label><input id="med-dosage" placeholder="e.g. 100mg"></div>
                </div>
                <div class="form-row-3">
                    <div><label>Time (HH:MM)</label><input id="med-time" type="time" value="08:00"></div>
                    <div><label>Days</label><input id="med-days" value="mon,tue,wed,thu,fri,sat,sun" placeholder="mon,tue,..."></div>
                    <div><label>Notes</label><input id="med-notes" placeholder="Take with food"></div>
                </div>
                <div class="mt-1">
                    <button class="btn btn-primary" onclick="addMedication()">+ Add Medication</button>
                </div>
            </div>
            <div class="card">
                <h3>&#128203; Active Medications</h3>
                <table>
                    <thead><tr><th>Name</th><th>Dosage</th><th>Time</th><th>Days</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="med-table"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>&#128220; Medication Log</h3>
                <table>
                    <thead><tr><th>Medication</th><th>Taken At</th><th>Confirmed By</th></tr></thead>
                    <tbody id="med-log-table"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>&#9200; Active Snoozes</h3>
                <table>
                    <thead><tr><th>Medication</th><th>Snooze Until</th><th>Created</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="med-snooze-table"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>&#128276; Medication Notification History</h3>
                <table>
                    <thead><tr><th>Notification</th><th>Action</th><th>Source</th><th>Time</th></tr></thead>
                    <tbody id="med-notif-table"></tbody>
                </table>
            </div>
        </div>

        <!-- â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-events" class="section">
            <div class="card">
                <h3>&#128197; Add Event</h3>
                <div class="form-row">
                    <div><label>Title</label><input id="evt-title" placeholder="e.g. Doctor appointment"></div>
                    <div><label>Date &amp; Time</label><input id="evt-time" type="datetime-local"></div>
                </div>
                <div class="form-row-3">
                    <div><label>Reminder (min before)</label><input id="evt-reminder" type="number" value="60"></div>
                    <div><label>Morning brief</label>
                        <select id="evt-brief">
                            <option value="1">Yes</option>
                            <option value="0">No</option>
                        </select>
                    </div>
                    <div><label>Description</label><input id="evt-desc" placeholder="Optional details"></div>
                </div>
                <div class="mt-1">
                    <button class="btn btn-primary" onclick="addEvent()">+ Add Event</button>
                </div>
            </div>
            <div class="card">
                <h3>&#128203; All Events</h3>
                <table>
                    <thead><tr><th>Title</th><th>Date/Time</th><th>Reminder</th><th>Brief</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="evt-table"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>&#128276; Event Notification History</h3>
                <table>
                    <thead><tr><th>Notification</th><th>Action</th><th>Source</th><th>Time</th></tr></thead>
                    <tbody id="evt-notif-table"></tbody>
                </table>
            </div>
        </div>

        <!-- â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-files" class="section">
            <div class="card">
                <h3>&#128193; Upload File</h3>
                <div class="form-row">
                    <div>
                        <label>Select file</label>
                        <input type="file" id="file-upload" style="padding:.4rem">
                    </div>
                    <div style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" onclick="uploadFile()">&#8593; Upload</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h3>&#128203; Files in data/</h3>
                <div class="mt-1" style="margin-bottom:.6rem">
                    <a class="btn btn-sm btn-success" href="/api/admin/files/db-backup" target="_blank">&#128190; Download DB Backup</a>
                </div>
                <table>
                    <thead><tr><th>Name</th><th>Size</th><th>Modified</th><th>Actions</th></tr></thead>
                    <tbody id="files-table"></tbody>
                </table>
            </div>
        </div>

        <!-- â”€â”€ Memory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-memory" class="section">
            <div class="card">
                <h3>&#129504; Add Memory Entry</h3>
                <div class="form-row-3">
                    <div><label>Key</label><input id="mem-key" placeholder="e.g. favorite_color"></div>
                    <div><label>Value</label><input id="mem-val" placeholder="e.g. blue"></div>
                    <div><label>Category</label><input id="mem-cat" value="preference" placeholder="preference"></div>
                </div>
                <div class="mt-1">
                    <button class="btn btn-primary" onclick="addMemory()">+ Add Entry</button>
                </div>
            </div>
            <div class="card">
                <h3>&#128203; All Memory Entries</h3>
                <table>
                    <thead><tr><th>Key</th><th>Value</th><th>Category</th><th>Updated</th><th>Actions</th></tr></thead>
                    <tbody id="mem-table"></tbody>
                </table>
            </div>
        </div>

        <!-- â”€â”€ Emergency Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="sec-contacts" class="section">
            <div class="card">
                <h3>&#128222; Add Emergency Contact</h3>
                <div class="form-row">
                    <input id="ct-name" placeholder="Short name (e.g. Jana)" />
                    <input id="ct-fullname" placeholder="Full name (e.g. Jana Novakova)" />
                    <input id="ct-relationship" placeholder="Relationship (e.g. daughter)" />
                    <input id="ct-phone" placeholder="Phone (e.g. +420123456789)" />
                    <button class="btn btn-primary" onclick="addContact()">+ Add Contact</button>
                </div>
            </div>
            <div class="card">
                <h3>&#128203; Emergency Contacts</h3>
                <table>
                    <thead><tr><th>Name</th><th>Full Name</th><th>Relationship</th><th>Phone</th><th>Created</th><th>Actions</th></tr></thead>
                    <tbody id="contacts-table"></tbody>
                </table>
            </div>
            <div class="card">
                <h3>&#128172; Sent SMS Messages</h3>
                <table>
                    <thead><tr><th>Contact</th><th>Phone</th><th>Message</th><th>Status</th><th>SNS ID</th><th>Sent At</th><th>Actions</th></tr></thead>
                    <tbody id="sms-log-table"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API = '/api/admin';
    async function api(path, opts = {}) {
        const res = await fetch(API + path, {
            headers: { 'Content-Type': 'application/json' },
            ...opts,
        });
        return res.json();
    }
    function toast(msg) {
        const el = document.createElement('div');
        el.className = 'toast';
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2500);
    }
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmtDt(s) {
        if (!s) return '-';
        try { return new Date(s).toLocaleString(); } catch { return s; }
    }

    // â”€â”€ Tab Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('nav button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('sec-' + btn.dataset.tab).classList.add('active');
            loadSection(btn.dataset.tab);
        });
    });

    // Load dashboard on initial page load
    loadSection('dashboard');

    function loadSection(tab) {
        if (tab === 'dashboard') loadDashboard();
        else if (tab === 'settings') loadSettings();
        else if (tab === 'medications') { loadMedications(); loadMedLog(); loadMedSnoozes(); loadMedNotifications(); }
        else if (tab === 'events') { loadEvents(); loadEventNotifications(); }
        else if (tab === 'memory') loadMemory();
        else if (tab === 'files') loadFiles();
        else if (tab === 'contacts') { loadContacts(); loadSmsLog(); }
    }

    // â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDashboard() {
        const d = await api('/dashboard');
        document.getElementById('dashboard-stats').innerHTML = `
            <div class="stat-card"><div class="num">${d.active_medications}</div><div class="label">Active Medications</div></div>
            <div class="stat-card"><div class="num">${d.active_events}</div><div class="label">Active Events</div></div>
            <div class="stat-card"><div class="num">${d.memory_entries}</div><div class="label">Memory Entries</div></div>
            <div class="stat-card"><div class="num"><span class="badge ${d.scheduler.enabled === 'true' ? 'badge-on' : 'badge-off'}">${d.scheduler.enabled === 'true' ? 'ON' : 'OFF'}</span></div><div class="label">Scheduler (every ${d.scheduler.interval_minutes} min)</div></div>
            <div class="stat-card"><div class="num">${d.push_subscriptions}${d.push_stale > 0 ? ' <span style="font-size:0.7em;color:var(--accent)">('+d.push_stale+' stale)</span>' : ''}</div><div class="label">Push Subscriptions</div></div>
            <div class="stat-card"><div class="num">${d.emergency_contacts || 0}</div><div class="label">Emergency Contacts</div></div>
            <div class="stat-card"><div class="num">${d.sms_sent || 0}</div><div class="label">SMS Sent</div></div>
        `;
        const ul = document.getElementById('dashboard-upcoming');
        if (!d.upcoming_events.length) {
            ul.innerHTML = '<li class="empty">No upcoming events</li>';
        } else {
            ul.innerHTML = d.upcoming_events.map(e =>
                `<li><strong>${fmtDt(e.event_time)}</strong> &mdash; ${esc(e.title)} <span style="color:var(--text-dim)">(reminder ${e.reminder_minutes}min before)</span></li>`
            ).join('');
        }
        loadPushSubscriptions();
    }

    // â”€â”€ Push Subscriptions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadPushSubscriptions() {
        try {
            const subs = await api('/push-subscriptions');
            const tbody = document.getElementById('push-subs-body');
            if (!subs.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-dim)">No push subscriptions</td></tr>';
                return;
            }
            tbody.innerHTML = subs.map(s => {
                const failBadge = s.fail_count > 0
                    ? `<span class="badge badge-off">${s.fail_count}</span>`
                    : `<span class="badge badge-on">0</span>`;
                const ua = s.user_agent ? s.user_agent.substring(0, 40) + (s.user_agent.length > 40 ? '...' : '') : '-';
                return `<tr>
                    <td title="${esc(s.endpoint)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(s.endpoint_short)}</td>
                    <td title="${esc(s.user_agent || '')}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ua)}</td>
                    <td>${s.created_at ? fmtDt(s.created_at) : '-'}</td>
                    <td>${s.last_success_at ? fmtDt(s.last_success_at) : '<span style="color:var(--text-dim)">never</span>'}</td>
                    <td>${failBadge}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deletePushSub(${s.id})">ğŸ—‘ï¸</button></td>
                </tr>`;
            }).join('');
        } catch (e) {
            console.error('Failed to load push subscriptions:', e);
        }
    }
    window.loadPushSubscriptions = loadPushSubscriptions;

    async function deletePushSub(id) {
        if (!confirm('Delete this push subscription?')) return;
        await fetch(`/api/admin/push-subscriptions/${id}`, { method: 'DELETE' });
        loadPushSubscriptions();
    }
    window.deletePushSub = deletePushSub;

    async function deleteAllPushSubs() {
        if (!confirm('Delete ALL push subscriptions? Users will need to re-subscribe.')) return;
        await fetch('/api/admin/push-subscriptions/all', { method: 'DELETE' });
        loadPushSubscriptions();
    }
    window.deleteAllPushSubs = deleteAllPushSubs;

    async function deleteStalePushSubs() {
        if (!confirm('Delete all subscriptions with fail_count > 0?')) return;
        await fetch('/api/admin/push-subscriptions/stale', { method: 'DELETE' });
        loadPushSubscriptions();
    }
    window.deleteStalePushSubs = deleteStalePushSubs;

    // â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SETTING_META = {
        timezone: { label: 'Timezone', type: 'select', options: ['Europe/Prague','Europe/London','Europe/Berlin','America/New_York','America/Chicago','America/Los_Angeles','Asia/Tokyo','UTC'] },
        language: { label: 'Language', type: 'select', options: ['en','cs'] },
        voice_id: { label: 'Voice ID', type: 'select', options: ['tiffany','matthew','amy','ruth','gregory'] },
        scheduler_enabled: { label: 'Scheduler Enabled', type: 'select', options: ['true','false'] },
        scheduler_interval_minutes: { label: 'Scheduler Interval (min)', type: 'number' },
        notification_advance_minutes: { label: 'Default Notification Advance (min)', type: 'number' },
        system_prompt: { label: 'System Prompt Override', type: 'textarea' },
    };

    let _settings = [];
    async function loadSettings() {
        const data = await api('/settings');
        _settings = data.settings;
        const form = document.getElementById('settings-form');
        form.innerHTML = _settings.map(s => {
            const meta = SETTING_META[s.key] || { label: s.key, type: 'text' };
            let input = '';
            if (meta.type === 'select') {
                input = `<select id="set-${s.key}">${meta.options.map(o => `<option value="${o}" ${o === s.value ? 'selected' : ''}>${o}</option>`).join('')}</select>`;
            } else if (meta.type === 'textarea') {
                input = `<textarea id="set-${s.key}">${esc(s.value)}</textarea>`;
            } else if (meta.type === 'number') {
                input = `<input type="number" id="set-${s.key}" value="${esc(s.value)}">`;
            } else {
                input = `<input type="text" id="set-${s.key}" value="${esc(s.value)}">`;
            }
            return `<label>${meta.label} <span style="color:var(--text-dim);font-size:.7rem">${esc(s.description || '')}</span></label>${input}`;
        }).join('');
    }
    async function saveSettings() {
        for (const s of _settings) {
            const el = document.getElementById('set-' + s.key);
            if (!el) continue;
            const newVal = el.value;
            if (newVal !== s.value) {
                await api('/settings/' + s.key, { method: 'PUT', body: JSON.stringify({ value: newVal }) });
            }
        }
        toast('Settings saved!');
        loadSettings();
    }

    // â”€â”€ Medications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMedications() {
        const data = await api('/medications');
        const tbody = document.getElementById('med-table');
        if (!data.medications.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty">No medications yet</td></tr>';
            return;
        }
        tbody.innerHTML = data.medications.map(m => `
            <tr>
                <td>${esc(m.name)}</td>
                <td>${esc(m.dosage || '-')}</td>
                <td>${esc(m.schedule_time)}</td>
                <td style="font-size:.75rem">${esc(m.days)}</td>
                <td><span class="badge ${m.active ? 'badge-on' : 'badge-off'}">${m.active ? 'Active' : 'Inactive'}</span></td>
                <td class="actions">
                    <button class="btn btn-sm btn-ghost" onclick="toggleMed(${m.id}, ${m.active})">${m.active ? 'Disable' : 'Enable'}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMed(${m.id})">Delete</button>
                </td>
            </tr>
        `).join('');
    }
    async function addMedication() {
        const name = document.getElementById('med-name').value.trim();
        const time = document.getElementById('med-time').value;
        if (!name || !time) return toast('Name and time required');
        await api('/medications', { method: 'POST', body: JSON.stringify({
            name, dosage: document.getElementById('med-dosage').value,
            schedule_time: time, days: document.getElementById('med-days').value,
            notes: document.getElementById('med-notes').value,
        })});
        document.getElementById('med-name').value = '';
        document.getElementById('med-dosage').value = '';
        document.getElementById('med-notes').value = '';
        toast('Medication added!');
        loadMedications();
    }
    async function toggleMed(id, current) {
        await api('/medications/' + id, { method: 'PUT', body: JSON.stringify({ active: current ? 0 : 1 }) });
        toast('Medication updated');
        loadMedications();
    }
    async function deleteMed(id) {
        if (!confirm('Delete this medication?')) return;
        await api('/medications/' + id, { method: 'DELETE' });
        toast('Medication deleted');
        loadMedications();
    }
    async function loadMedLog() {
        const data = await api('/medication-log');
        const tbody = document.getElementById('med-log-table');
        if (!data.log.length) {
            tbody.innerHTML = '<tr><td colspan="3" class="empty">No log entries</td></tr>';
            return;
        }
        tbody.innerHTML = data.log.map(l => `
            <tr><td>${esc(l.medication_name || '?')}</td><td>${fmtDt(l.taken_at)}</td><td>${esc(l.confirmed_by)}</td></tr>
        `).join('');
    }

    // â”€â”€ Medication Snoozes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMedSnoozes() {
        const data = await api('/medication-snoozes');
        const tbody = document.getElementById('med-snooze-table');
        if (!data.snoozes.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty">No snoozes</td></tr>';
            return;
        }
        const now = new Date();
        tbody.innerHTML = data.snoozes.map(s => {
            const until = new Date(s.snooze_until);
            const isActive = until > now;
            return `
            <tr>
                <td>${esc(s.medication_name || 'ID: ' + s.medication_id)}</td>
                <td>${fmtDt(s.snooze_until)}</td>
                <td style="font-size:.75rem">${fmtDt(s.created_at)}</td>
                <td><span class="badge ${isActive ? 'badge-on' : 'badge-off'}">${isActive ? 'Active' : 'Expired'}</span></td>
                <td class="actions">
                    <button class="btn btn-sm btn-danger" onclick="deleteSnooze(${s.id})">Delete</button>
                </td>
            </tr>`;
        }).join('');
    }
    async function deleteSnooze(id) {
        if (!confirm('Delete this snooze?')) return;
        await api('/medication-snoozes/' + id, { method: 'DELETE' });
        toast('Snooze deleted');
        loadMedSnoozes();
    }

    // â”€â”€ Medication Notification History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMedNotifications() {
        const data = await api('/notification-responses');
        const tbody = document.getElementById('med-notif-table');
        const medResponses = data.responses.filter(r => r.notification_id.startsWith('med_'));
        if (!medResponses.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty">No medication notification responses</td></tr>';
            return;
        }
        tbody.innerHTML = medResponses.map(r => {
            const actionBadge = r.action === 'taken'
                ? '<span class="badge badge-on">âœ… Taken</span>'
                : r.action === 'snooze'
                ? '<span class="badge" style="background:var(--warn);color:#fff">â° Snoozed</span>'
                : `<span class="badge badge-off">${esc(r.action)}</span>`;
            return `
            <tr>
                <td><code style="font-size:.75rem">${esc(r.notification_id)}</code></td>
                <td>${actionBadge}</td>
                <td>${esc(r.source)}</td>
                <td style="font-size:.75rem">${fmtDt(r.created_at)}</td>
            </tr>`;
        }).join('');
    }

    // â”€â”€ Event Notification History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadEventNotifications() {
        const data = await api('/notification-responses');
        const tbody = document.getElementById('evt-notif-table');
        const evtResponses = data.responses.filter(r => r.notification_id.startsWith('event_') || r.notification_id.startsWith('brief_'));
        if (!evtResponses.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty">No event notification responses</td></tr>';
            return;
        }
        tbody.innerHTML = evtResponses.map(r => {
            const actionBadge = r.action === 'confirm'
                ? '<span class="badge badge-on">âœ… Confirmed</span>'
                : r.action === 'dismiss'
                ? '<span class="badge badge-off">Dismissed</span>'
                : `<span class="badge" style="background:var(--accent2);color:#fff">${esc(r.action)}</span>`;
            return `
            <tr>
                <td><code style="font-size:.75rem">${esc(r.notification_id)}</code></td>
                <td>${actionBadge}</td>
                <td>${esc(r.source)}</td>
                <td style="font-size:.75rem">${fmtDt(r.created_at)}</td>
            </tr>`;
        }).join('');
    }

    // â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadEvents() {
        const data = await api('/events');
        const tbody = document.getElementById('evt-table');
        if (!data.events.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty">No events yet</td></tr>';
            return;
        }
        tbody.innerHTML = data.events.map(e => `
            <tr>
                <td>${esc(e.title)}</td>
                <td>${fmtDt(e.event_time)}</td>
                <td>${e.reminder_minutes} min</td>
                <td>${e.morning_brief ? 'Yes' : 'No'}</td>
                <td>
                    <span class="badge ${e.active ? 'badge-on' : 'badge-off'}">${e.active ? 'Active' : 'Inactive'}</span>
                    ${e.notified ? ' <span style="color:var(--text-dim);font-size:.7rem">notified</span>' : ''}
                </td>
                <td class="actions">
                    <button class="btn btn-sm btn-ghost" onclick="toggleEvent(${e.id}, ${e.active})">${e.active ? 'Disable' : 'Enable'}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteEvent(${e.id})">Delete</button>
                </td>
            </tr>
        `).join('');
    }
    async function addEvent() {
        const title = document.getElementById('evt-title').value.trim();
        const time = document.getElementById('evt-time').value;
        if (!title || !time) return toast('Title and time required');
        await api('/events', { method: 'POST', body: JSON.stringify({
            title,
            event_time: new Date(time).toISOString(),
            reminder_minutes: parseInt(document.getElementById('evt-reminder').value) || 60,
            morning_brief: parseInt(document.getElementById('evt-brief').value),
            description: document.getElementById('evt-desc').value,
        })});
        document.getElementById('evt-title').value = '';
        document.getElementById('evt-desc').value = '';
        toast('Event added!');
        loadEvents();
    }
    async function toggleEvent(id, current) {
        await api('/events/' + id, { method: 'PUT', body: JSON.stringify({ active: current ? 0 : 1 }) });
        toast('Event updated');
        loadEvents();
    }
    async function deleteEvent(id) {
        if (!confirm('Delete this event?')) return;
        await api('/events/' + id, { method: 'DELETE' });
        toast('Event deleted');
        loadEvents();
    }

    // â”€â”€ Memory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadMemory() {
        const data = await api('/memory');
        const tbody = document.getElementById('mem-table');
        if (!data.memory.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty">No memory entries</td></tr>';
            return;
        }
        tbody.innerHTML = data.memory.map(m => `
            <tr>
                <td><code>${esc(m.key)}</code></td>
                <td>${esc(m.value)}</td>
                <td>${esc(m.category)}</td>
                <td style="font-size:.75rem">${fmtDt(m.updated_at)}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-danger" onclick="deleteMemory('${esc(m.key)}')">Delete</button>
                </td>
            </tr>
        `).join('');
    }
    async function addMemory() {
        const key = document.getElementById('mem-key').value.trim();
        const val = document.getElementById('mem-val').value.trim();
        if (!key || !val) return toast('Key and value required');
        await api('/memory', { method: 'POST', body: JSON.stringify({
            key, value: val, category: document.getElementById('mem-cat').value || 'preference',
        })});
        document.getElementById('mem-key').value = '';
        document.getElementById('mem-val').value = '';
        toast('Memory saved!');
        loadMemory();
    }
    async function deleteMemory(key) {
        if (!confirm('Delete "' + key + '"?')) return;
        await api('/memory/' + encodeURIComponent(key), { method: 'DELETE' });
        toast('Memory deleted');
        loadMemory();
    }

    // â”€â”€ Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadFiles() {
        const data = await api('/files');
        const tbody = document.getElementById('files-table');
        if (!data.files.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty">No files in data/</td></tr>';
            return;
        }
        tbody.innerHTML = data.files.map(f => `
            <tr>
                <td><code>${esc(f.name)}</code></td>
                <td>${esc(f.size_human)}</td>
                <td style="font-size:.75rem">${fmtDt(f.modified)}</td>
                <td class="actions">
                    <a class="btn btn-sm btn-ghost" href="/api/admin/files/download/${encodeURIComponent(f.name)}" target="_blank">&#8595; Download</a>
                    ${f.name !== 'sonic2life.db' ? `<button class="btn btn-sm btn-danger" onclick="deleteFile('${esc(f.name)}')">Delete</button>` : ''}
                </td>
            </tr>
        `).join('');
    }
    async function uploadFile() {
        const input = document.getElementById('file-upload');
        if (!input.files.length) return toast('Select a file first');
        const formData = new FormData();
        formData.append('file', input.files[0]);
        const res = await fetch(API + '/files/upload', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.status === 'ok') {
            toast('File uploaded: ' + data.filename);
            input.value = '';
            loadFiles();
        } else {
            toast('Upload failed');
        }
    }
    async function deleteFile(name) {
        if (!confirm('Delete file "' + name + '"?')) return;
        await api('/files/' + encodeURIComponent(name), { method: 'DELETE' });
        toast('File deleted');
        loadFiles();
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadDashboard();
    
        // â”€â”€ Emergency Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadContacts() {
            const res = await fetch('/api/admin/contacts');
            const data = await res.json();
            const tbody = document.getElementById('contacts-table');
            tbody.innerHTML = data.contacts.filter(c => c.active).map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.fullname || '-'}</td>
                    <td>${c.relationship || '-'}</td>
                    <td>${c.phone}</td>
                    <td>${c.created_at || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteContact(${c.id}, '${c.name}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addContact() {
            const name = document.getElementById('ct-name').value.trim();
            const fullname = document.getElementById('ct-fullname').value.trim();
            const relationship = document.getElementById('ct-relationship').value.trim();
            const phone = document.getElementById('ct-phone').value.trim();
            if (!name || !phone) { alert('Name and phone are required'); return; }
            await fetch('/api/admin/contacts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name, fullname, relationship, phone})
            });
            document.getElementById('ct-name').value = '';
            document.getElementById('ct-fullname').value = '';
            document.getElementById('ct-relationship').value = '';
            document.getElementById('ct-phone').value = '';
            loadContacts();
        }

        async function deleteContact(id, name) {
            if (!confirm(`Delete contact "${name}"?`)) return;
            await fetch(`/api/admin/contacts/${id}`, {method: 'DELETE'});
            loadContacts();
        }

        
        // â”€â”€ SMS Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadSmsLog() {
            const res = await fetch('/api/admin/sms-log');
            const data = await res.json();
            const tbody = document.getElementById('sms-log-table');
            if (!data.sms_log || data.sms_log.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#888">No SMS messages sent yet</td></tr>';
                return;
            }
            tbody.innerHTML = data.sms_log.map(s => {
                const statusBadge = s.status === 'sent'
                    ? '<span style="color:#27ae60;font-weight:bold">âœ… sent</span>'
                    : s.status === 'failed'
                    ? `<span style="color:#e74c3c;font-weight:bold">âŒ failed</span><br><small>${s.error_detail || ''}</small>`
                    : `<span style="color:#f39c12;font-weight:bold">âš ï¸ ${s.status}</span><br><small>${s.error_detail || ''}</small>`;
                return `
                <tr>
                    <td><strong>${s.contact_name}</strong></td>
                    <td>${s.phone}</td>
                    <td style="max-width:300px;word-wrap:break-word">${s.message}</td>
                    <td>${statusBadge}</td>
                    <td><small>${s.sns_message_id || '-'}</small></td>
                    <td>${s.created_at || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteSmsLog(${s.id})">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }

        async function deleteSmsLog(id) {
            if (!confirm('Delete this SMS log entry?')) return;
            await fetch(`/api/admin/sms-log/${id}`, {method: 'DELETE'});
            loadSmsLog();
        }

        </script>
</body>
</html>
